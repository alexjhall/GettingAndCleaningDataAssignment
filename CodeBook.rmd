---
title: CodeBook - Getting and Cleaning Data Assignment
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(readr)
library(kableExtra)
```


```{r, include=FALSE, cache = TRUE}
# Loads objects from run_analysis.R script so that they can be used in this
# document.
source("run_analysis.R", local = knitr::knit_global())
```

# Introduction
This codebook accompanies the README and run_analysis.R script, developed as part of the 
'Getting and Cleaning Data' assignment.
The intention of this codebook (as per the assignment instructions) is to  modify and update the available codebooks supplied with the data, to indicate all the variables and summaries calculated, along with units, and any other relevant information.


This codebook contains:

* Features_info content describing how the features (variables) were derived from the raw data

* Detailed walk though of transformations performed on original data to generate the output table 'FinalTidyData'

* Data dictionary for the table 'FinalTidyData' generated by the run_analysis.R script


It does not contain:

* Full information on how the original data was collected and pre-processed. Please see accompanying README for this.

* The actual script used to perform the transformations. Please see the run_analysis.R script for this.


# Features information
This is the features_info.txt document supplied with the original data which describes how the features (variables) were derived from the raw data.

```{r}
cat(readLines(paste0(GenDir, "/features_info.txt")), sep = '\n')
```



# Transformations
The following steps were carried out to read and manipulate the raw data in order to create the FinalTidyData summary table. The code and accompanying comments to perform these transformations are included in the run_analysis.R script.

## 
1. A zipped datafile was downloaded from this location <link url> https://d396qusza40orc.cloudfront.net/getdata%2Fprojectfiles%2FUCI%20HAR%20Dataset.zip
and then unzipped. 

2. The activity_labels.txt file was read and the columns were relabeled as 'ActivityClass' and 'Activity'

3. The features.txt was read and delimited so that a numeric vector could be created with values associated with 'mean' and 'std' measurements that appeared in the x indices of the features.txt list of values. This numeric vector was called 'FeatueMeanStdSelect'.

4. Three 'test' files were read: subject_test.txt, X_test.txt and Y_test.txt. These were column-bound together using `cbind()` and columns were appropriately labeled to produce a dataframe containing the subject ID, activity class and the 561 feature measures. An additional column was added with the value 'test' so that these records could be identified as test when combined with the training data.

5. Step 4 was repeated with the training data.

6. The 'test' and 'train' dataframe were bound together using `rbind()`, to create the 'TestTrain' dataframe. 

7. The values in the 'Features' object previously loaded were used to describe the 561 feature columns in the TestTrain dataset. A minor amendment was made to replace instances of 'BodyBody' in the the new column names with 'Body' as these were believed to be there mistakenly.

8. A subset of the TestTrain dataframe was extracted to produce TestTrainMeanStd. The criteria for the subset came from the 'FeatueMeanStdSelect' described in step 3 above.

9. The TestTrainMeanStd dataframe was left_joined with the previously read ActivityLabels dataframe to bring in the activity label (walking, sitting etc) as opposed to just the activity ID. This label was converted to sentence case, had underscored replaces with spaces and was brought forward in the dataframe. The ActivityClass variable was dropped from this dataframe.

10. The FinalTidyData table was produced by grouping TestTrainMeanStd by Subject, Activity and DatasetGroup, then summarizing this table by taking the mean of the feature measure columns.





# Data dictionary
The following data dictionary describes the data in the FinalTidyData table.
This markdown file also contains the code to generate this data dictionary.
  
```{r, cache = FALSE}

## Load packages
library(tidyverse)
library(stringr)


## Creating codebook
  CodeBookTable <- 
    data.frame(matrix(NA, nrow = ncol(FinalTidyData), ncol = 6))

  # Assign column names
  names(CodeBookTable) <- c("Column number",
                            "Variable name",
                            "Variable format",
                            "Possible values",
                            "Units (if applicable)",
                            "Variable description"
                            )
  
  # Populate column number
  CodeBookTable$`Column number` <- seq_len(nrow(CodeBookTable))
  
  # Populate variable name
  CodeBookTable$`Variable name` <- names(FinalTidyData)
  
  # Populate variable format
  CodeBookTable$`Variable format` <-
    unlist(lapply(FinalTidyData, class))
  
  # Populate Possible values
  CodeBookTable$`Possible values` <-
    c("1-30", 
      paste(sort(unique(FinalTidyData$Activity)), collapse = ", "),
      paste(sort(unique(FinalTidyData$DatasetGroup)), collapse = ", "),
      rep.int("[-1,1]", 66)
    )
  
  # Populate Units
  CodeBookTable$`Units (if applicable)` <-
    ifelse(
      grepl("Acc", CodeBookTable$`Variable name`) &
      grepl("mean()", CodeBookTable$`Variable name`),
        "Standard gravity units 'g'",
        ifelse(
          grepl("Gyro", CodeBookTable$`Variable name`) &
          grepl("mean()", CodeBookTable$`Variable name`),
          "Radians/second",
          NA
        )
    )
  
  # Populate variable description
  # Create string that replaces shorthand with full words
  
  #
  VarDesc <-
    paste(ifelse(grepl("mean()", CodeBookTable$`Variable name`), "Mean", ""),
          ifelse(grepl("std()", CodeBookTable$`Variable name`), "Standard deviation for", ""),
          ifelse(grepl("^t", CodeBookTable$`Variable name`), "time domain", ""),
          ifelse(grepl("^f", CodeBookTable$`Variable name`), "frequency domain", ""),
          ifelse(grepl("BodyAcc", CodeBookTable$`Variable name`), "body acceleration", ""),
          ifelse(grepl("GravityAcc", CodeBookTable$`Variable name`), "gravity acceleration", ""),
          ifelse(grepl("Gyro", CodeBookTable$`Variable name`), "angular velocity", ""),
          ifelse(grepl("Jerk", CodeBookTable$`Variable name`), "jerk", ""),
          ifelse(grepl("Mag", CodeBookTable$`Variable name`), "magnitude", ""),
          ifelse(grepl("X$", CodeBookTable$`Variable name`), "X signal", ""),
          ifelse(grepl("Y$", CodeBookTable$`Variable name`), "Y signal", ""),
          ifelse(grepl("Z$", CodeBookTable$`Variable name`), "Z signal", "")
    )
  
  # Removes whitespace    
  VarDesc <- 
    str_replace(gsub("\\s+", " ", str_trim(VarDesc)), "B", "b")
  
  # Appends manual description for first three variables
  VarDesc <-
    c("The subject who performed the activity for each window sample",
      "Activity subject was performing when wearing smartphone with embedded accelerometer and gyroscope",
      "Random partition into test or training dataset",
      VarDesc[4:69])
  
  
  # Populates variable description with VarDesc values
  CodeBookTable$`Variable description` <- VarDesc
  
  # Format into html table
  CodeBookTable %>%
    kbl() %>%
      kable_styling(bootstrap_options = c("striped", "hover"))

```


 
